name: Build Flutter Flavors with Signing

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    name: Build APK and App Bundle with Signing
    runs-on: ubuntu-latest

    strategy:
      matrix:
        flavor: [dev, staging, prod]

    steps:
      # Step 1: Checkout the code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: stable

      # Step 3: Decode Keystore
      - name: Decode and Save Keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 --decode > release-keystore.jks

      # Step 4: Cache dependencies
      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.pub-cache
            build
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      # Step 5: Install Dependencies
      - name: Install Flutter dependencies
        run: flutter pub get

      # Step 6: Build APK for the current flavor
      - name: Build APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: flutter build apk --flavor ${{ matrix.flavor }} --target lib/main_${{ matrix.flavor }}.dart

      # Step 7: Build App Bundle for the current flavor
      - name: Build App Bundle
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS_PASSWORD: ${{ secrets.KEY_ALIAS_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        run: flutter build appbundle --flavor ${{ matrix.flavor }} --target lib/main_${{ matrix.flavor }}.dart

      # Step 8: Upload Build Artifacts
      - name: Upload APK and App Bundle
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.flavor }}-build-artifacts
          path: |
            build/app/outputs/flutter-apk/*.apk
            build/app/outputs/bundle/${{ matrix.flavor }}/release/*.aab
