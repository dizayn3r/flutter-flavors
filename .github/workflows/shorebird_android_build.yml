name: Android Build & Release

on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - main
  #     - release/*
  # pull_request:

env:
  SHOREBIRD_TOKEN: ${{ secrets.SHOREBIRD_TOKEN }}

jobs:
  release:
    name: Build & Release Android
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: üõ† Checkout Repository
        uses: actions/checkout@v3

      # Setup Java
      - name: ‚òïÔ∏è Set Up Java 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: temurin

      # Set up Flutter
      - name: üê¶ Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: 3.27.1
          channel: stable

      # Install Shorebird CLI
      - name: üê¶ Install Shorebird CLI
        uses: shorebirdtech/setup-shorebird@v1

      - name: Verify Shorebird Installation
        run: shorebird --version

      # Ensure Shorebird is authenticated
      - name: üîë Authenticate Shorebird
        run: shorebird doctor

      # Debug Environment (Optional)
      - name: üêû Debug Tools & Environment
        run: |
          which flutter
          which shorebird
          which java
          java -version
          flutter doctor

      # Build & Release Shorebird for multiple flavors
      - name: üöÄ Build & Release (Dev)
        run: |
          shorebird release android --verbose --flavor=dev --target=lib/main_dev.dart --artifact=apk
        env:
          JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17.0.13-11/x64
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEYSTORE_ALIAS: ${{ secrets.KEYSTORE_ALIAS }}

      - name: üöÄ Build & Release (Staging)
        if: github.ref == 'refs/heads/staging'
        run: |
          shorebird release android --verbose --flavor=staging --target=lib/main_staging.dart --artifact=apk
        env:
          JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17.0.13-11/x64
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEYSTORE_ALIAS: ${{ secrets.KEYSTORE_ALIAS }}

      - name: üöÄ Build & Release (Prod)
        if: github.ref == 'refs/heads/main'
        run: |
          shorebird release android --verbose --flavor=prod --target=lib/main_prod.dart --artifact=apk
        env:
          JAVA_HOME: /opt/hostedtoolcache/Java_Temurin-Hotspot_jdk/17.0.13-11/x64
          KEYSTORE_FILE: ${{ secrets.KEYSTORE_FILE }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEYSTORE_ALIAS: ${{ secrets.KEYSTORE_ALIAS }}
